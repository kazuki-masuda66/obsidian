# 20250523進捗報告

### FY25Pricing本番状況

(5/23) : Rベースで1,483件(完了1,457件)、アカウントベースで799 件(完了765件)対応中

前回(4/25) : Rベースで1,451件(完了1,407件)、アカウントベースで784件(完了730件)対応中

### FY25 Award 本番状況

- 現在292件、Nominaitonを受領済み。285件CVA DraftをSalesに提供済み。7件対応中。
    - NAのアカウント250件はAward Conversion対象外で、NA Salesが直接Game Planシートに入力する運用のため対象外
    - 残250件
        - 100件→Eagle XのAwardを経ずにONE Froceに登録済みを確認。これらについては個別にPricing Combineを実施済み。3月時点での確認のため、最新状況を再度確認予定（＋α）。
        - 150件→Regionサイドと協力して、営業と確認中

### 増田引き継ぎ

- 業務引き継ぎはConversion→Flourance、Award→Leandroに引き継ぎ完了
- 伊藤さんにPJノウハウ等のスキトラを開始
- その他残作業は3点
    - Tender DB Dashboardの確立
        - データのクレンジング：概ね完了
        - KPIの整備：進行中。来週Makiさんと打ち合わせ予定。
        - Dashboardイメージの共有：イメージを現在作成中で来週Gozuさんに共有予定。 DDE Program Increment 17 (PI17) （June 2025 to Aug 2025）に乗せてもらう予定。
    - Sales UI Portalの開発
        - IndonesiaやThaiセッションを経て要件が少し大きくなっているため、段階的にリリースするよう調整する予定
            - Step1:Potal上にSalesが関連するデータ、Linkをすべて表示→実際のデータ入力は既存のGシート側で
            - Step2:Portal上で一部入力もできるようにする（Sales Input等）
    - Pricing Excel VBAのGシート化方針策
        - 現状の課題
            - 全体２K以上のステップ数
            - 大量のシートをPricing tool側で保持して処理している→BQ側で保持して、処理してPricing tool側に渡してあげるべき
            - 保守性に課題（変数・関数の命名規則、集約、ファイルパス記述、シート名、長大なネスト文）：なにかを変更したときの影響範囲の特定がかなり難しい→外部化・設定化
            - 特に性能課題になる箇所：Pricing tool creation、Surchargeのセットアップ、Submission（ファイルの存在チェック、移動、シートコピー、別名保存、Google Formへの送信など、多岐にわたる処理を1つのモジュールで実施）
        - 進め方
            - 2週間単位でどこまで進めるかを区切る
            - その単位でYing Enのレビューを入れる
            - VBA⇔Google Sheet + AppScriptを柔軟に切り替えられるようにしておく
                - 主：VBA、従：Google Sheet + AppScriptでテスト
                - 主：Google Sheet + AppScript、従：VBAに切り替え

参考：

## Pricing Tool 機能一覧

### I. データインポートと初期セットアップ機能

1. **ONE Formatからの基本データインポート:**
    - 顧客の入札情報（経路、コンテナタイプ、数量、現行レート、ターゲットレート、顧客インテンションなど）をONE Format Excelファイルから読み込み、価格設定シートに展開します。
    - ラウンド1処理と後続ラウンド（R2以降）処理で、データの扱い方が一部異なります（例: 前ラウンドデータの参照・マージ）。
    - 関連モジュール/関数: `Mod_CreatePricingTool.importONEFormat`, `Mod_SubseqRound.importONEFormat_subseq`
2. **顧客備考およびD&D備考のインポート:**
    - ONE Formatから最大20項目の顧客備考およびD&D関連備考を価格設定シートの指定列にインポートします。
    - 関連モジュール/関数: `Mod_CreatePricingTool.add20Remarks`, `Mod_SubseqRound.add20Remarks_subseq`
3. **シートレイアウト（縦型/横型）の識別と初期設定:**
    - 価格設定シートのデータ構造が縦型（コンテナサイズごとに行が分かれる）か横型（コンテナサイズごとに列が分かれる）かを自動識別します。
    - 識別結果に基づき、後続の列設定やデータ処理の方式を調整します。
    - 関連モジュール/関数: `Mod_CreatePricingTool.identifyHoriOrVert`, `Mod_SubseqRound.identifyHoriOrVert_subseq`
4. **必須列情報の設定とデータ検証ルール適用:**
    - ONE Formatの"PricerInputList"シートに基づき、価格設定シートの各列に対して、顧客シートへエクスポートする際の列番号、必須入力フラグ（Y/M または Y）、データ型、データ検証（ドロップダウンリスト）などを設定します。
    - ドロップダウンリストのマスターは "Dropdown_CS" シートに集約されます。
    - 関連モジュール/関数: `Mod_CreatePricingTool.updateMandatoryColumns`, `Mod_CreatePricingTool.UpdateColNo`, `Mod_SubseqRound.updateMandatoryColumns_subseq`, `Mod_SubseqRound.UpdateColNo_subseq`
5. **顧客シートの列ヘッダー・書式設定:**
    - `UpdateColNo` / `UpdateColNo_subseq` 内で、価格設定シートのヘッダー行に対して、エクスポート対象となる列のヘッダー名にコメントを追加したり、背景色や文字色を変更（例: マゼンタ背景、白文字）したりします。
6. **作業ファイルの初期設定:**
    - 新規に価格設定ツールを作成する際や、後続ラウンドのシートを作成する際に、シート名を顧客名とラウンド番号に基づいて適切に設定します。
    - 関連ファイルパス情報などを "File info" シートに記録します。

### II. マスターデータ管理・更新機能

1. **OBSロケーショングループ情報の更新:**
    - 価格設定シートの経路情報に基づき、OBS (Origin Basic Surcharge) の適用地域グループを決定する数式を設定します。
    - 外部のOBSマスターファイルから最新データを取得し、ツール内の "OBS Master" シートを更新後、関連する名前付き範囲を再設定します。
    - 関連モジュール/関数: `Mod_RefreshDataBase.UpdateOBS_Location`
2. **為替レート情報の更新:**
    - 外部の為替レートファイルから最新レートを取得し、ツール内の "Currency" シートを更新後、関連する名前付き範囲 ("ROE", "Currency") を再設定します。
    - 関連モジュール/関数: `Mod_RefreshDataBase.refresh_ROE`
3. **PriSMサーチャージデータの抽出と更新:**
    - 価格設定シートで使用されている国ペアに基づき、外部のPRISMサーチャージファイルから関連データを取得し、ツール内の "Autorate Surcharge" シートを更新します。
    - 関連モジュール/関数: `Mod_RefreshDataBase.ExtractPRISMdata`
4. **起点別・仕向地別・海上輸送区間別サーチャージデータの抽出と更新:**
    - 価格設定シートの経路情報に基づき、外部サーチャージファイルから起点別、仕向地別、または海上輸送区間別のサーチャージデータを取得し、対応するシート ("Origin Charge", "Dest Charge", "Ocean Charge") を更新します。
    - 関連モジュール/関数: `Mod_RefreshDataBase.ExtractPRISMdata_Origin_Dest_Ocean`
5. **ITS (Inland Transport Surcharge) データと内陸ルート情報の取得・設定:**
    - 外部のITSデータファイルから関連する内陸輸送ルート情報を取得し、ツール内の対応シート ("Inland Route Precarriage", "Inland Route Oncarriage") を更新します。
    - 価格設定シートの内陸ルート関連列にドロップダウンリストと関連情報（Gateway Port, Transmode, WGT, Inland Haulage料金）を設定します。
    - 関連モジュール/関数: `Mod_RefreshDataBase.RetreiveITSData`
6. **サーチャージマスターの更新:**
    - 価格設定シートで使用されているサービススコープコード (SSC) に基づき、外部の分割されたサーチャージマスターCSVファイル群から関連データを取得し、ツール内の "Surcharge" シートを更新します。
    - 関連モジュール/関数: `Mod_RefreshDataBase.refreshSurchargeMaster`
7. **リフティング実績データの更新（顧客別/NAC別）:**
    - 価格設定シートの情報（SC/RFA番号、Group Customer名など）に基づき、外部のリフティング実績ファイルから関連データを取得し、ツール内の "Lifting Performance" シートまたは "Lifting Performance 2" シートを更新します。
    - 関連モジュール/関数: `Mod_RefreshDataBase.refreshLifting_Cust`, `Mod_RefreshDataBase.refreshLifting_NAC`
8. **E2Eルート情報の更新とドロップダウン設定:**
    - 価格設定シートで使用されている国ペアに基づき、外部の分割されたE2Eルート情報CSVファイル群から関連データを取得し、ツール内の "Route" シートを更新します。
    - 価格設定シートのE2Eルート列に、取得した情報に基づくドロップダウンリストを設定します。
    - 存在しないルート情報は別ファイルに記録します。
    - 関連モジュール/関数: `Mod_RefreshDataBase.refreshE2E_PortPair`
9. **DMT（Demurrage & Detention）契約情報およびタリフ情報の更新:**
    - 外部の契約DMTデータファイルおよびDMTタリフファイルから関連データを取得し、ツール内の "Contract DMT" シートおよび "DMT Tariff" シートを更新します。
    - 価格設定シートのDMT関連列に参照数式を設定します。
    - 関連モジュール/関数: `Mod_RefreshDataBase.refreshDMT`
10. **ターゲットCM情報の更新（EA/WAトレード別）:**
    - 外部のEA (Europe-Asia) および WA (Westbound Asia) Target CMファイルからデータを取得し、対応するシート ("Target CM (EA)", "Target CM (WA)") を更新します。
    - 価格設定シートのTarget CM関連列に参照数式を設定します。
    - 関連モジュール/関数: `Mod_ForMacroButton.btnGetTargetCM_EA_Click`, `Mod_ForMacroButton.btnGetTargetCM_WA_Click`
11. **RPS（Rate Positioning System）データの取得と反映:**
    - ツール内の "RPS_SVC_Lane" および "RPS_Summary" シートを参照し、価格設定シートの目標TEU、調整、サマリー情報列に数式を設定します。
    - 関連モジュール/関数: `Mod_RefreshDataBase.retrieveRPSData`

### III. 価格設定支援・計算機能

1. **サーチャージ条件（Subject/Include/Fixed）の更新と料金取得:**
    - 価格設定シート上の各サーチャージ項目について、ベンチマーク（顧客リクエスト、LT MRG、現行契約など）に基づいてサブジェクト/インクルード/フィックスドの条件を更新します。
    - 決定された条件に基づき、サーチャージマスターから対応する料金（クオンタム）を取得・設定します。
    - 関連モジュール/関数: `Mod_OperationFunction.Update_Surcharge_Condition`, `Mod_OperationFunction.GetSurcharge`, `Mod_OperationFunction.Shortlist_Surcharge`
2. **不足サーチャージ列の自動追加:**
    - テンダー情報やPRISMデータに含まれるサーチャージが価格設定ツール上に存在しない場合、自動的に列を挿入し、テンプレートに基づいて初期設定を行います。
    - 関連モジュール/関数: `Mod_OperationFunction.adhocAddSurcharge`, `Mod_OperationFunction.findMissingSurcharge`
3. **オールインレートの計算:**
    - オファーレートと、サブジェクト/フィックスドとして設定されたサーチャージの合計に基づいて、オールインレートを計算し、対応する列に設定します。
    - 中間作業シート "All in Rate Calclation" を使用する場合があります。
    - 関連モジュール/関数: `Mod_OperationFunction.Calculate_All_IN_Rate`
4. **ベースレートの逆算:**
    - オールインレートオファーと、サブジェクト/フィックスドサーチャージ合計から、ベースレートを逆算して設定します。
    - 関連モジュール/関数: `Mod_OperationFunction.baseRateCalculation`
5. **サブジェクト/フィックスドサーチャージ小計の計算:**
    - 「Subject」または「Fixed」とマークされたサーチャージの合計金額を計算し、「Subtotal of Subject/Fixed Surcharges」列に設定します。
    - 関連モジュール/関数: `Mod_OperationFunction.sumSubjSurcharge`
6. **インクルーシブサーチャージ小計の計算:**
    - 「Include」とマークされたサーチャージの合計金額を計算し、「Subtotal of Inclusive Surcharges」列に設定します。
    - 関連モジュール/関数: `Mod_OperationFunction.sumInclSurcharge`
7. **コスト/CM（Contribution Margin）関連の計算式設定:**
    - E2Eコスト、CYCYコスト、Expected CM/TEU、Expected CM/TON、Required FRT（ターゲットCMからの逆算）などを計算する数式を価格設定シートに設定します。
    - これには、隠れコスト（Hidden Cost）やOIH/DIH（内陸輸送料）も考慮されます。
    - 関連モジュール/関数: 主に `importONEFormat`, `importONEFormat_subseq`, `populateFormula_newLanes` 内で数式設定。
8. **D&Dフリータイムの数値検証設定:**
    - D&Dのフリータイム関連列に対し、0から100000の整数のみ入力可能なデータ検証を設定します。
    - 関連モジュール/関数: `Mod_CreatePricingTool.dndValidation`, `Mod_SubseqRound.dndValidation_subseq`
9. **レーン追加機能と関連数式設定:**
    - 価格設定シートと顧客シートに新しいレーン（行）を追加し、レーンID生成、Pricing Row # 設定、基本情報のコピー、主要な計算式の自動設定を行います。
    - 関連モジュール/関数: `Mod_ForMacroButton.btnAddLane_Click`, `Mod_OperationFunction.populateFormula_newLanes`
10. **コスト項目追加機能と関連計算への反映:**
    - ユーザーが定義した追加のコスト項目を価格設定シートに列として挿入します。
    - 追加項目が「Hidden Cost」とされた場合、E2EコストおよびCYCYコストの計算式に自動的に組み込まれます。
    - 関連モジュール/関数: `Mod_ForMacroButton.btbAddItem_Click` (フォーム表示), `Mod_OperationFunction.addCostItem`
11. **経路情報の整合性チェック（ハイライト表示）:**
    - プライサーが設定した経路情報（POR, POL, POD, DEL, Term, Cargo Type）と、顧客シートからインポートされた元の経路情報を比較し、差異があれば該当セルを黄色でハイライトします。
    - 関連モジュール/関数: `Mod_ForMacroButton.btnRouteCheck_Click`

### IV. UI・操作支援機能

1. **各種ユーザーフォームの表示:**
    - コントロールパネル、表示設定、コスト項目追加、インランドルート取得設定、DMT情報取得設定、サーチャージ設定、オールインレート計算設定、ベースレート計算設定、プライサー備考入力などのための専用ユーザーフォームを表示します。
    - 関連モジュール/関数: `Mod_ForMacroButton.btnCntlPanel_Click`, `btnDisplay_Click`, `btbAddItem_Click`, `btnRetrieveInlandRoutes_Click`, `btnGetDMT_Click`, `btnSetSurcharge_Click`, `btnCalcAllIn_Click`, `btnBaseRate_Click`, `btnSubmission_Click`, `Mod_CommonFunction.Display_Screen`
2. **シート内特定セクションへのジャンプ機能:**
    - 価格設定シート内の定義済みセクション（例: "Route", "Rate Structure" など）へ迅速に移動します。
    - 関連モジュール/関数: `Mod_ForMacroButton.btnMove_Click`
3. **サーチャージ列の表示/非表示切り替え:**
    - ユーザーの選択や処理状況に応じて、価格設定シート上の多数のサーチャージ関連列の表示・非表示を制御します。
    - 関連モジュール/関数: `Mod_OperationFunction.Change_Display`, `Mod_OperationFunction.Update_Surcharge_Condition`
4. **実行時間記録:**
    - 特定の主要な操作（エクスポート、提出など）が実行された日時とユーザー情報を外部Excelファイルに記録します。
    - 関連モジュール/関数: `Mod_OperationFunction.captureExecutionTime`

### V. データエクスポートと提出・通知機能

1. **顧客シートへの価格情報・備考・経路情報などのエクスポート:**
    - 価格設定シートで最終決定された価格、サーチャージ条件、経路情報、備考などを顧客シートの対応する列に転記します。
    - コンテナサイズごとのデータや、通貨換算（必要な場合）も行います。
    - 関連モジュール/関数: `Mod_ForMacroButton.btnExportControlPanel_Click` (フォーム表示) 内の処理
2. **TT (Transit Time) 関連情報のエクスポート準備:**
    - 顧客シートにTT情報を設定するためのキー情報を生成し、TTマスターシートとの連携を準備します。
    - 関連モジュール/関数: `Mod_OperationFunction.submissionFunction` (内部で `importTTData` 呼び出し)
3. **提出用Excelファイルの自動生成と保存:**
    - 顧客シート、TTシート、およびその他関連シートを新しいExcelファイルにコピーし、指定された命名規則とフォルダパスで保存します。
    - 既存ファイルがある場合は、"!old"フォルダに移動（バックアップ）します。
    - 関連モジュール/関数: `Mod_OperationFunction.submissionFunction`
4. **作業ファイルの自動保存（バージョン管理含む）:**
    - 現在のPricing Toolの作業内容を指定フォルダにタイムスタンプ付きでコピー保存します。
    - Pricing Sheetのみを値と書式で別ファイルに保存する機能もあります。
    - 関連モジュール/関数: `Mod_OperationFunction.saveWorkingFile`, `Mod_OperationFunction.savePricingSheet`
5. **Google Formを利用した処理完了通知の送信:**
    - ファイル提出完了後、関連情報をGoogle FormにPOST送信し、関係者にメール通知を行います。
    - 関連モジュール/関数: `Mod_OperationFunction.SubmitGform`

### VI. 共通・基盤機能

1. **列番号と列アルファベットの相互変換:**
    - Excelの列番号（数値）と列アルファベット（例: "A", "AA"）を相互に変換します。
    - 関連モジュール/関数: `Mod_CommonFunction.change_val`
2. **文字列内での特定文字の出現位置検索:**
    - 文字列内で、指定した部分文字列がn回目に出現する位置を検索します。
    - 関連モジュール/関数: `Mod_CommonFunction.InStrNum`
3. **ADODBを利用した外部Excel/CSVファイルへのデータアクセス:**
    - ツール全体を通して、ADODBオブジェクトを利用して外部Excelファイル（.xlsx, .xls）やCSVファイルに接続し、SQLライクなクエリでデータを読み書きします。
4. **ユーザーフォームの画面中央表示:**
    - 指定されたユーザーフォームをアクティブウィンドウの中央に表示します。
    - 関連モジュール/関数: `Mod_CommonFunction.Display_Screen`
5. **数式のフィルダウン:**
    - 指定範囲の先頭セルの数式を、指定された矩形範囲にフィルダウンします。
    - 関連モジュール/関数: `Mod_CommonFunction.PasteFormula`